<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>娃娃機記帳</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        label, select, input { display: block; margin: 10px 0; }
        button { margin-right: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .total-row { font-weight: bold; background-color: #eef; }
    </style>
</head>
<body>

    <h2>娃娃機記帳</h2>

    <label for="store">選擇店名：</label>
    <select id="store" onchange="updateMachineOptions()">
        <option value="三重店" selected>三重店</option>
        <option value="重慶店">重慶店</option>
    </select>

    <label for="machine">選擇台號：</label>
    <select id="machine">
        <option value="">請先選擇店名</option>
    </select>

    <label for="date">選擇日期：</label>
    <input type="date" id="date">

    <label for="amount">輸入金額：</label>
    <input type="number" id="amount" placeholder="輸入金額">

    <button onclick="recordTransaction()">記錄</button>
    <button onclick="exportToExcel()">匯出 Excel</button>

    <h3>重慶店 記錄列表</h3>
    <button onclick="clearRecords('重慶店')">清除重慶店記錄</button>
    <table>
        <thead>
            <tr>
                <th>日期</th>
                <th>台號</th>
                <th>金額</th>
                <th>目前累積金額</th>
            </tr>
        </thead>
        <tbody id="recordListChongqing"></tbody>
    </table>

    <h3>三重店 記錄列表</h3>
    <button onclick="clearRecords('三重店')">清除三重店記錄</button>
    <table>
        <thead>
            <tr>
                <th>日期</th>
                <th>台號</th>
                <th>金額</th>
                <th>目前累積金額</th>
            </tr>
        </thead>
        <tbody id="recordListSanchong"></tbody>
    </table>

    <script>
        function updateMachineOptions() {
            const store = document.getElementById("store").value;
            const machineSelect = document.getElementById("machine");
            machineSelect.innerHTML = "";

            let firstMachine = "1"; // 預設選擇第一台

            if (store === "重慶店") {
                for (let i = 1; i <= 27; i += 2) {
                    let option = document.createElement("option");
                    option.value = i;
                    option.textContent = i;
                    machineSelect.appendChild(option);
                }
            } else if (store === "三重店") {
                for (let i = 1; i <= 25; i++) {
                    let option = document.createElement("option");
                    option.value = i;
                    option.textContent = i;
                    machineSelect.appendChild(option);
                }
                ["巨1", "巨2"].forEach(machine => {
                    let option = document.createElement("option");
                    option.value = machine;
                    option.textContent = machine;
                    machineSelect.appendChild(option);
                });
            }

            machineSelect.value = firstMachine;
        }

        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split("T")[0];
        }

        function recordTransaction() {
            const store = document.getElementById("store").value;
            const machine = document.getElementById("machine").value;
            const amount = document.getElementById("amount").value;
            let date = document.getElementById("date").value;

            if (!date) {
                date = getTodayDate();
                document.getElementById("date").value = date;
            }

            if (!store || !machine || !amount) {
                alert("請填寫完整資料");
                return;
            }

            let records = JSON.parse(localStorage.getItem(store)) || [];
            records.push({ date, machine, amount });
            localStorage.setItem(store, JSON.stringify(records));

            document.getElementById("amount").value = "";
            loadRecords();
        }

        function loadRecords() {
            ["重慶店", "三重店"].forEach(store => {
                const recordList = document.getElementById(store === "重慶店" ? "recordListChongqing" : "recordListSanchong");
                recordList.innerHTML = "";

                let records = JSON.parse(localStorage.getItem(store)) || [];
                let totalMap = {};

                records.forEach(record => {
                    let machine = record.machine;
                    let amount = parseFloat(record.amount) || 0;

                    if (!totalMap[machine]) {
                        totalMap[machine] = 0;
                    }
                    totalMap[machine] += amount;
                });

                records.forEach(record => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.machine}</td>
                        <td>${record.amount}</td>
                        <td>${totalMap[record.machine]}</td>
                    `;
                    recordList.appendChild(row);
                });
            });
        }

        function clearRecords(store) {
            localStorage.removeItem(store);
            loadRecords();
        }

        function exportToExcel() {
            let wb = XLSX.utils.book_new();

            ["重慶店", "三重店"].forEach(store => {
                let records = JSON.parse(localStorage.getItem(store)) || [];
                if (records.length > 0) {
                    let ws = XLSX.utils.json_to_sheet(records, { header: ["date", "machine", "amount"] });
                    XLSX.utils.sheet_add_aoa(ws, [["日期", "台號", "金額"]], { origin: "A1" });
                    XLSX.utils.book_append_sheet(wb, ws, store);
                }
            });

            XLSX.writeFile(wb, "bookkeeping.xlsx");
        }

        window.onload = () => {
            document.getElementById("date").value = getTodayDate();
            updateMachineOptions(); // 預設台號
            loadRecords();
        };
    </script>

</body>
</html>

